import streamlit as st
import pandas as pd
import requests
import json
import os

# Define the series IDs you want to fetch
series_ids = ['LNS11000000', 'LNS13000000', 'LNS14000000', 'CES0000000001']

# API headers and payload
headers = {'Content-type': 'application/json'}
payload = json.dumps({
    "seriesid": series_ids,
    "startyear": "2014",
    "endyear": "2024"
})

# Fetch data from the BLS API
@st.cache_data(ttl="1d")  # Cache for 24 hours
def collect_bls_data():
    response = requests.post(
        'https://api.bls.gov/publicAPI/v2/timeseries/data/',
        headers=headers,
        data=payload
    )
    return json.loads(response.text)

# Process the JSON response into DataFrames
@st.cache_data(ttl="1d")  # Cache for 24 hours
def process_bls_data(json_data):
    dataframes_dict = {}
    for series in json_data['Results']['series']:
        series_id = series['seriesID']
        parsed_data = []

        for item in series['data']:
            year = item['year']
            period = item['period']
            value = float(item['value'])
            month = period.replace('M', '')
            parsed_data.append({
                'Year': year,
                'Period': period,
                'Month': month,
                'Value': value
            })

        df = pd.DataFrame(parsed_data)
        df['Date'] = pd.to_datetime(df['Year'] + '-' + df['Month'], format='%Y-%m', errors='coerce')
        df = df[['Date', 'Value', 'Year', 'Month', 'Period']]
        dataframes_dict[series_id] = df

    return dataframes_dict

# Main execution
json_data = collect_bls_data()
dataframes_dict = process_bls_data(json_data)

# Save DataFrames to CSV
for series_id, df in dataframes_dict.items():
    csv_file = f"{series_id}.csv"
    df.to_csv(csv_file, index=False)
    print(f"Saved {csv_file}")
